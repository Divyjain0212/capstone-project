---
- name: Update all packages
  dnf:
    name: "*"
    state: latest
    update_cache: true

- name: Install required packages
  dnf:
    name:
      - git
      - curl
      - wget
      - vim
      - htop
      - unzip
      - python3
      - nginx
      - amazon-cloudwatch-agent
    state: present

- name: Install Node.js repository
  shell: |
    curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
  args:
    creates: /etc/yum.repos.d/nodesource-el9.repo

- name: Install Node.js
  dnf:
    name: nodejs
    state: present

- name: Create application directory
  file:
    path: /opt/app
    state: directory
    owner: ec2-user
    group: ec2-user
    mode: "0755"

- name: Configure CloudWatch Agent
  template:
    src: cloudwatch-config.json.j2
    dest: /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
    mode: "0644"
  notify: Restart CloudWatch Agent

- name: Start CloudWatch Agent
  systemd:
    name: amazon-cloudwatch-agent
    enabled: true
    state: started
